name: CI Pipeline

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]

jobs:
    test:
        runs-on: ubuntu-latest

        services:
            postgres:
                image: postgres:16-alpine
                env:
                    POSTGRES_DB: test
                    POSTGRES_USER: test
                    POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD || 'test_secret' }}
                ports:
                    - 5432:5432
                options: >-
                    --health-cmd="pg_isready -U test -d test"
                    --health-interval=10s
                    --health-timeout=5s
                    --health-retries=5
            redis:
                image: redis:alpine
                ports:
                    - 6379:6379

        steps:
            - uses: actions/checkout@v4

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: "8.4"
                  extensions: mbstring, xml, ctype, iconv, intl, pdo_pgsql, redis
                  coverage: xdebug

            - name: Cache Composer packages
              id: composer-cache
              uses: actions/cache@v3
              with:
                  path: vendor
                  key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-php-

            - name: Install dependencies
              run: composer install --prefer-dist --no-progress

            - name: Setup environment file
              run: cp .env.test .env.local

            - name: Analyse statique avec PHPStan
              run: php ./vendor/bin/phpstan analyze

            - name: Lint Symfony
              run: php bin/console lint:container --env=prod

            - name: Run tests
              run: php ./bin/phpunit
              env:
                  DATABASE_URL: "postgresql://test:${{ secrets.POSTGRES_PASSWORD || 'test_secret' }}@127.0.0.1:5432/test"
                  REDIS_URL: "redis://127.0.0.1:6379"
